# -*- coding: utf-8 -*-
"""Fashion Visual Director Chatbot.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ORqiR0q3IYV0xcpkRVuqZhVHLI8hfjox
"""

# visual_director_app.py
import streamlit as st
import openai
from datetime import datetime

st.set_page_config(page_title="Fashion Visual Director Bot", layout="wide", page_icon="ğŸ¬")

st.title("ğŸ¬ Fashion Visual Director Bot")
st.write("íŒ¨ì…˜ ë¹„ì£¼ì–¼ ë””ë ‰í„° ì—­í• ë¡œ ì½˜ì…‰íŠ¸Â·ë¬´ë“œë³´ë“œÂ·ì´¬ì˜ì§€ì‹œë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.")

# 1) API í‚¤ ë¡œë”© (ê¶Œì¥: Streamlit Cloud secrets ì‚¬ìš©)
st.sidebar.header("API ì„¤ì •")
use_secrets = st.sidebar.checkbox("Use Streamlit secrets (ê¶Œì¥)", value=True)
if use_secrets:
    # Streamlit Cloud: Settings > Secretsì—ì„œ OPENAI_API_KEY ê°’ ì €ì¥
    try:
        OPENAI_API_KEY = st.secrets["OPENAI_API_KEY"]
    except Exception:
        OPENAI_API_KEY = ""
else:
    OPENAI_API_KEY = st.sidebar.text_input("OpenAI API Key", type="password")

if not OPENAI_API_KEY:
    st.sidebar.warning("OpenAI API Keyê°€ ì—†ìŠµë‹ˆë‹¤. ì‹¤í–‰í•˜ë ¤ë©´ í‚¤ ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.")

# 2) ì‚¬ìš©ì ì…ë ¥
st.sidebar.header("ì˜µì…˜")
model = st.sidebar.text_input("Model (ê¶Œì¥ ì˜ˆ: gpt-4o-mini ë˜ëŠ” gpt-4o)", value="gpt-4o-mini")
temperature = st.sidebar.slider("ì°½ì˜ì„± (temperature)", 0.0, 1.0, 0.7)
max_tokens = st.sidebar.slider("Max tokens", 128, 2048, 512)

st.subheader("í”„ë¡œì íŠ¸ ì •ë³´")
project_name = st.text_input("í”„ë¡œì íŠ¸/ì»¬ë ‰ì…˜ ì´ë¦„", "Autumn Fragment")
format_choice = st.selectbox("í¬ë§·", ["í™”ë³´ (Editorial)", "ëŸ°ì›¨ì´ (Runway)", "ì˜¨ë¼ì¸ ë£©ë¶ (Lookbook)"])
target = st.text_input("íƒ€ê¹ƒ (ì˜ˆ: 20-30ëŒ€, K-fashion lovers ë“±)", "20-30ëŒ€, ë¬´ë“œ ì¤‘ì‹¬ íŠ¸ë Œë“œ ì†Œë¹„ì")
keywords = st.text_input("í‚¤ì›Œë“œ/í…Œë§ˆ (ì‰¼í‘œë¡œ êµ¬ë¶„ ì˜ˆ: deconstructivism, muted pastels)", "deconstructivism, muted pastels")
budget_note = st.text_input("ì˜ˆì‚°/ì œì•½(ì„ íƒ)", "Low budget - student project")

user_prompt = st.text_area("ë””í…Œì¼ ìš”ì²­ (ì˜ˆ: ì´¬ì˜ì¥ì†Œ, ëª¨ë¸ ì½˜ì…‰íŠ¸, ì†Œí’ˆ ë“±)",
                           "ì›ë‹¨ì˜ ì§ˆê°ê³¼ ë””í…Œì¼ì´ ê°•ì¡°ë˜ëŠ” ìŠ¤íŠœë””ì˜¤ í™”ë³´. ìì—°ê´‘ ëŠë‚Œ")

# 3) System prompt (ì—­í• )
system_prompt = """
ë„ˆëŠ” 'íŒ¨ì…˜ ë¹„ì£¼ì–¼ ë””ë ‰í„°'ì•¼.
ì‚¬ìš©ìê°€ ì¤€ ì •ë³´(í”„ë¡œì íŠ¸ëª…, í¬ë§·, íƒ€ê¹ƒ, í‚¤ì›Œë“œ, ì˜ˆì‚°ì œì•½, ë””í…Œì¼)ë¥¼ ì½ê³  ë‹¤ìŒ í•­ëª©ì„ ì¶œë ¥í•´:
1) í•µì‹¬ ì½˜ì…‰íŠ¸(í•œ ë¬¸ì¥)
2) ë¹„ì£¼ì–¼ ë””ë ‰ì…˜: ì¡°ëª…/ì´¬ì˜ìŠ¤íƒ€ì¼/êµ¬ì„±/ëª¨ë¸ìŠ¤íƒ€ì¼/ì†Œí’ˆ(ê° í•­ëª© 2-4ê°€ì§€)
3) ì»¬ëŸ¬ íŒ”ë ˆíŠ¸: 3~5ê°œì˜ HEX ì½”ë“œ ë° ê°„ë‹¨í•œ ì„¤ëª…
4) í…ìŠ¤ì²˜/ì†Œì¬ ì¶”ì²œ(3ê°œ)
5) ìƒ·ë¦¬ìŠ¤íŠ¸(3ì»·) - ê° ì»·ì˜ êµ¬ì„±ê³¼ ëª©ì 
6) ì˜ˆì‚°/ì‹œê°„ ì œì•½ ìˆì„ ë•Œì˜ í˜„ì‹¤ì ì¸ ë³€í˜• íŒ (ê° 1-2ê°œ)
ì¶œë ¥ì€ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ êµ¬ì„±í•˜ê³ , ì‹¤ë¬´ì—ì„œ ë°”ë¡œ ì°¸ê³ í•  ìˆ˜ ìˆê²Œ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´.
"""

# 4) ì‹¤í–‰ ë²„íŠ¼
if st.button("ì œì•ˆ ìƒì„±"):
    if not OPENAI_API_KEY:
        st.error("OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì‚¬ì´ë“œë°”).")
    else:
        openai.api_key = OPENAI_API_KEY

        system_msg = {"role": "system", "content": system_prompt}
        user_msg_text = f"""
Project: {project_name}
Format: {format_choice}
Target: {target}
Keywords: {keywords}
Budget note: {budget_note}
Detail: {user_prompt}
"""
        user_msg = {"role": "user", "content": user_msg_text}

        with st.spinner("ë””ë ‰ì…˜ ìƒì„± ì¤‘..."):
            try:
                resp = openai.ChatCompletion.create(
                    model=model,
                    messages=[system_msg, user_msg],
                    temperature=temperature,
                    max_tokens=max_tokens,
                )
                # ChatCompletion.response êµ¬ì¡°ì— ë”°ë¼ ì¡°ì •
                assistant_text = resp["choices"][0]["message"]["content"].strip()
                st.markdown("### âœ¨ ì œì•ˆ ê²°ê³¼")
                st.markdown(assistant_text)

                # ë¡œê·¸ ì €ì¥(ì„ íƒ)
                if st.checkbox("ëŒ€í™” ê¸°ë¡ ì €ì¥"):
                    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
                    st.write(f"ì €ì¥ë¨: {project_name}_{ts}")
                    # ì‹¤ì œ ì €ì¥ì€ ë¡œì»¬/DBë¡œ êµ¬í˜„ ê°€ëŠ¥ (ì˜ˆ: st.download_buttonìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ ì œê³µ)
            except Exception as e:
                st.error(f"API í˜¸ì¶œì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")